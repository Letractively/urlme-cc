viewModel.zip.subscribe(function(t){localStorage.setItem("zip",t)}),viewModel.theaterName.subscribe(function(t){localStorage.setItem("theaterName",t)}),viewModel.theaterId.subscribe(function(t){localStorage.setItem("theaterId",t)});var router=new Router;ianhd.registerNamespace("app"),ianhd.app={controls:{enterZip:function(){return $(".enterZip")},logo:function(){return $("#logo")},menu:function(){return $("nav")},menuIcon:function(){return $(".fa-bars")},movie:function(){return $("#movie")},nearMe:function(){return $("#nearMe")},overlay:function(){return $("#overlay")},searchBox:function(){return $("input.search")},searchIcon:function(){return $(".fa-search")},selectTheaterBody:function(){return $(".selectTheater .bootstrap-dialog-message")},singleMovie:function(){return $(".singleMovie")},theater:function(){return $(".theater")},theatersWithMovies:function(){return $("#theatersWithMovies")},zip:function(){return $(".zip")}},selectors:{closePopup:"#overlay,.closePopup",selectMovie:"#theatersWithMovies .movie a",selectTheater:".selectTheater a"},init:function(){return"undefined"!=typeof localStorage&&navigator.geolocation?(ianhd.app.controls.overlay().css("height",$(document).height()),ianhd.app.initHistory(),ianhd.app.bindControls(),void 0):(document.writeln("Please use a more recent browser to view this site.  I recommend <a href='http://www.google.com/chrome'>Chrome</a>."),void 0)},loadTheaters:function(){BootstrapDialog.show({title:"Select a theater",message:"<span class='hint'>Loading...</span>",cssClass:"selectTheater",buttons:[{label:"Cancel",cssClass:"btn-default",action:function(t){t.close()}}],onshown:function(){var t="{0}api/theaters?zip={1}".format(apiBaseUrl,viewModel.zip());$.get(t,function(t){var e=ianhd.app.controls.selectTheaterBody();e.html(""),$.each(t,function(t,n){e.append("<a href='/showtimes/{0}/{1}' data-theater-id='{1}'>{2}</a>".format(viewModel.zip(),n.id,n.name))})})}})},loadShowtimes:function(t,e){console.log("Loading showtimes...");var n="{0}api/theaters-with-movies?zip={1}&theaterId={2}".format(apiBaseUrl,t,e),i=ianhd.app.controls.theatersWithMovies();i.html("<span class='hint'>Loading...</span>"),$.get(n,function(t){var e=new Date;e=parseInt(e.getHours()+""+e.getMinutes()),$.each(t,function(t,n){$.each(n.movies,function(t,n){var i=[];$.each(n.showtimes,function(t,n){var r=Number(n.match(/^(\d+)/)[1]),o=Number(n.match(/:(\d+)/)[1]);o=10>o?"0"+o:o;var a=-1==n.indexOf("am");r=12!=r&&a?r+12:r;var s=parseInt(r+""+o),l=e>s;i.push({isPast:l,showtime:n})}),n.showtimes=i})});var n=$.templates("#theaterTmpl").render(t);i.html(n)})},loadMovie:function(t,e){console.log("Loading movie...");var n="{0}api/movie/{1}".format(apiBaseUrl,e),i=ianhd.app.controls.singleMovie();i.html("<span class='hint'>Loading</span>"),$.get(n,function(t){i.html(t)})},bindControls:function(){$(document).on("click",ianhd.app.selectors.selectTheater,function(t){t.preventDefault();var e=$(this);viewModel.theaterId(e.attr("data-theater-id")),viewModel.theaterName(e.html()),BootstrapDialog.closeAll(),router.navigate(e.attr("href"))}),$(document).on("click",ianhd.app.selectors.selectMovie,function(t){t.preventDefault();var e=$(this);viewModel.movieId(e.attr("data-movie-id")),router.navigate(e.attr("href"))}),ianhd.app.controls.nearMe().click(function(){var t=$(this);t.button("loading"),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var n="http://api.geonames.org/findNearbyPostalCodesJSON?lat={0}&lng={1}&username=codejkjk".format(e.coords.latitude,e.coords.longitude);$.ajax({url:n,dataType:"jsonp",success:function(e){var n=e.postalCodes[0].postalCode;viewModel.theaterId(""),viewModel.theaterName(""),viewModel.zip(n),ianhd.app.loadTheaters(),t.button("reset")},error:function(){}})},function(){alert("Error, please try again.")})}),ianhd.app.controls.enterZip().keyup(function(t){var e=$(this);if(13==t.keyCode){var n=$.trim(e.val());if(isNaN(n)||5!==n.length)return alert("Please enter a 5-digit zip code."),e.focus(),void 0;viewModel.theaterId(""),viewModel.theaterName(""),viewModel.zip(n),ianhd.app.loadTheaters()}}),ianhd.app.controls.theater().click(function(t){t.preventDefault(),ianhd.app.loadTheaters()}),ianhd.app.controls.zip().click(function(t){t.preventDefault(),viewModel.zip(""),router.navigate("/",!1)}),ianhd.app.controls.menuIcon().click(function(t){t.preventDefault();var e=$(this);e.toggleClass("fa-bars fa-times"),ianhd.app.controls.logo().toggle(),ianhd.app.controls.searchIcon().toggle();var n=ianhd.app.controls.menu();n.slideToggle()}),ianhd.app.controls.searchIcon().click(function(t){t.preventDefault();var e=$(this);e.toggleClass("fa-search fa-times");var n=ianhd.app.controls.searchBox();n.toggleClass("display"),ianhd.app.controls.logo().toggle(),n.hasClass("display")&&n.focus()})},initHistory:function(){router.route("/showtimes/:zip/:theaterId",function(t,e){console.log("route /showtimes/:zip/:theaterId"),ianhd.app.loadShowtimes(t,e)}),router.route("/:movieSlug/:movieId",function(t,e){console.log("route /:movieSlug/:movieId"),ianhd.app.loadMovie(t,e)}),router.route("/",function(){console.log("route /"),viewModel.movieId("")});var t=window.location.pathname;if(t.indexOf("showtimes")>=0){t=t.substr(t.indexOf("showtimes"));var e=t.split("/"),n=e[1],i=e[2];viewModel.zip(n),ianhd.app.loadShowtimes(n,i)}else if("/"!==t){var e=t.split("/"),r=e[1],o=e[2];viewModel.movieId(o),ianhd.app.loadMovie(r,o)}else viewModel.zip()&&viewModel.theaterId()&&ianhd.app.loadShowtimes(viewModel.zip(),viewModel.theaterId())}},$(function(){ianhd.app.init()});