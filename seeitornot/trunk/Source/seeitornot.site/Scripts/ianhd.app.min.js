viewModel.zip.subscribe(function(e){localStorage.setItem("zip",e)}),viewModel.theaterName.subscribe(function(e){localStorage.setItem("theaterName",e)}),viewModel.theaterId.subscribe(function(e){localStorage.setItem("theaterId",e)});var router=new Router;ianhd.registerNamespace("app"),ianhd.app={controls:{enterZip:function(){return $(".enterZip")},logo:function(){return $("#logo")},menu:function(){return $("nav")},menuIcon:function(){return $(".fa-bars")},movie:function(){return $("#movie")},nearMe:function(){return $("#nearMe")},overlay:function(){return $("#overlay")},searchBox:function(){return $("input.search")},searchIcon:function(){return $(".fa-search")},selectTheaterBody:function(){return $(".selectTheater .bootstrap-dialog-message")},singleMovie:function(){return $(".singleMovie")},theater:function(){return $(".theater")},theatersWithMovies:function(){return $("#theatersWithMovies")},zip:function(){return $(".zip")}},selectors:{closePopup:"#overlay,.closePopup",selectMovie:"#theatersWithMovies .movie a",selectTheater:".selectTheater a"},init:function(){return"undefined"!=typeof localStorage&&navigator.geolocation?(ianhd.app.controls.overlay().css("height",$(document).height()),ianhd.app.initHistory(),ianhd.app.bindControls(),void 0):(document.writeln("Please use a more recent browser to view this site.  I recommend <a href='http://www.google.com/chrome'>Chrome</a>."),void 0)},loadTheaters:function(){BootstrapDialog.show({title:"Select a theater",message:"<span class='hint'>Loading...</span>",cssClass:"selectTheater",buttons:[{label:"Cancel",cssClass:"btn-default",action:function(e){e.close()}}],onshown:function(){var e="{0}api/theaters?zip={1}".format(apiBaseUrl,viewModel.zip());$.get(e,function(e){var t=ianhd.app.controls.selectTheaterBody();t.html(""),$.each(e,function(e,o){t.append("<a href='/showtimes/{0}/{1}' data-theater-id='{1}'>{2}</a>".format(viewModel.zip(),o.id,o.name))})})}})},loadShowtimes:function(e,t){console.log("Loading showtimes...");var o="{0}api/theaters-with-movies?zip={1}&theaterId={2}".format(apiBaseUrl,e,t),a=ianhd.app.controls.theatersWithMovies();a.html("<span class='hint'>Loading...</span>"),$.get(o,function(e){var t=new Date;t=parseInt(t.getHours()+""+t.getMinutes()),$.each(e,function(e,o){$.each(o.movies,function(e,o){var a=[];$.each(o.showtimes,function(e,o){var i=Number(o.match(/^(\d+)/)[1]),n=Number(o.match(/:(\d+)/)[1]);n=10>n?"0"+n:n;var r=-1==o.indexOf("am");i=12!=i&&r?i+12:i;var s=parseInt(i+""+n),l=t>s;a.push({isPast:l,showtime:o})}),o.showtimes=a})});var o=$.templates("#theaterTmpl").render(e);a.html(o)})},loadMovie:function(e,t){console.log("Loading movie...");var o="{0}api/movie/{1}".format(apiBaseUrl,t),a=ianhd.app.controls.singleMovie();a.html("<span class='hint'>Loading</span>"),$.get(o,function(e){a.html(e)})},bindControls:function(){$(document).on("click",ianhd.app.selectors.selectTheater,function(e){e.preventDefault();var t=$(this);viewModel.theaterId(t.attr("data-theater-id")),viewModel.theaterName(t.html()),BootstrapDialog.closeAll(),router.navigate(t.attr("href"))}),$(document).on("click",ianhd.app.selectors.selectMovie,function(e){e.preventDefault();var t=$(this);viewModel.movieId(t.attr("data-movie-id")),router.navigate(t.attr("href"))}),ianhd.app.controls.nearMe().click(function(){var e=$(this);e.button("loading"),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(t){var o="http://api.geonames.org/findNearbyPostalCodesJSON?lat={0}&lng={1}&username=codejkjk".format(t.coords.latitude,t.coords.longitude);$.ajax({url:o,dataType:"jsonp",success:function(t){var o=t.postalCodes[0].postalCode;viewModel.theaterId(""),viewModel.theaterName(""),viewModel.zip(o),ianhd.app.loadTheaters(),e.button("reset")},error:function(){}})},function(){alert("Error, please try again.")})}),ianhd.app.controls.enterZip().keyup(function(e){var t=$(this);if(13==e.keyCode){var o=$.trim(t.val());if(isNaN(o)||5!==o.length)return alert("Please enter a 5-digit zip code."),t.focus(),void 0;viewModel.theaterId(""),viewModel.theaterName(""),viewModel.zip(o),ianhd.app.loadTheaters()}}),ianhd.app.controls.theater().click(function(e){e.preventDefault(),ianhd.app.loadTheaters()}),ianhd.app.controls.zip().click(function(e){e.preventDefault(),viewModel.zip(""),router.navigate("/",!1)}),ianhd.app.controls.menuIcon().click(function(e){e.preventDefault();var t=$(this);t.toggleClass("fa-bars fa-times"),ianhd.app.controls.logo().toggle(),ianhd.app.controls.searchIcon().toggle();var o=ianhd.app.controls.menu();o.slideToggle()}),ianhd.app.controls.searchIcon().click(function(e){e.preventDefault();var t=$(this);t.toggleClass("fa-search fa-times");var o=ianhd.app.controls.searchBox();o.toggleClass("display"),ianhd.app.controls.logo().toggle(),o.hasClass("display")&&o.focus()})},initHistory:function(){router.route("/showtimes/:zip/:theaterId",function(e,t){console.log("route /showtimes/:zip/:theaterId"),ianhd.app.loadShowtimes(e,t)}),router.route("/:movieSlug/:movieId",function(e,t){console.log("route /:movieSlug/:movieId"),ianhd.app.loadMovie(e,t)}),router.route("/",function(){console.log("route /"),viewModel.movieId("")});var e=window.location.pathname;if(e.indexOf("showtimes")>=0){e=e.substr(e.indexOf("showtimes"));var t=e.split("/"),o=t[1],a=t[2];viewModel.zip(o),ianhd.app.loadShowtimes(o,a)}else if("/"!==e){var t=e.split("/"),i=t[1],n=t[2];viewModel.movieId(n),ianhd.app.loadMovie(i,n)}else viewModel.zip()&&viewModel.theaterId()&&ianhd.app.loadShowtimes(viewModel.zip(),viewModel.theaterId())}},$(function(){ianhd.app.init()});