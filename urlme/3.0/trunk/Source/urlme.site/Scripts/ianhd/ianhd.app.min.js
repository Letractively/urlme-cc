ianhd.registerNamespace("app"),ianhd.app={controls:{shortenUrl:function(){return $("button[type='submit']")},success:function(){return $(".alert-success")},theRealCopy:function(){return $("#theRealCopy")}},selectors:{copyLinks:".copy",deleteLinks:".delete",overwrite:".overwrite"},init:function(){ianhd.app.loadData(),ianhd.app.bindControls(),ianhd.app.initZeroClipboard(),ianhd.app.removeHash()},findItemIndex:function(e){var t=e.closest("tr").attr("data-item-id"),n=!1,r=-1;return $.grep(viewModel.items(),function(e,a){return n||e.LinkId!=t?void 0:(n=!0,r=a,!0)}),r},initZeroClipboard:function(){ianhd.app.controls.theRealCopy().zclip({path:"ZeroClipboard.swf",copy:function(){return viewModel.toCopy()},afterCopy:function(){var e=$(viewModel.copyTriggerSelector()),t=e.html();e.html("<span style='text-align: center; width: 46px; display:inline-block; color: green;'><i class='fa fa-check'></i></span>"),setTimeout(function(){e.html(t)},1500)}}),$(document).on("mouseover",ianhd.app.selectors.copyLinks,function(e){e.stopPropagation();var t=$(this);if(t.addClass("hover"),t.hasClass("outputCopy"))viewModel.toCopy(viewModel.result()),viewModel.copyTriggerSelector(".outputCopy");else{var n=ianhd.app.findItemIndex(t),r=viewModel.items()[n];viewModel.toCopy(r.ShortUrl),viewModel.copyTriggerSelector("tr[data-item-id='{0}'] .copy".format(t.closest("tr").attr("data-item-id")))}$(".zclip").css("left",t.offset().left).css("top",t.offset().top)}),$(document).on("mouseover","table,.linkFormContainer",function(){var e=$(this);e.find(".copy").removeClass("hover"),$(".zclip").css("left",-100).css("top",-100)})},clearViewModel:function(){viewModel.longUrl(""),viewModel.path(""),viewModel.message("")},bindControls:function(){$(document).on("click",ianhd.app.selectors.overwrite,function(e){e.preventDefault();var t=$(this);BootstrapDialog.show({title:"Please Confirm",message:"Are you sure?",cssClass:"login-dialog",buttons:[{label:"Yes, overwrite",cssClass:"btn-primary",action:function(e){var n=t.attr("data-item-id"),r={destinationUrl:viewModel.longUrl(),linkId:n};$.post("links/overwrite",r,function(e){if(e.WasSuccessful){viewModel.result(e.Item.ShortUrl);var t=$("tr[data-item-id='{0}']".format(n))[0],r=dt.fnGetPosition(t),a="<a target='_blank' title='{0}' href='{0}'>{1}</a>".format(e.Item.DestinationUrl,e.Item.LongUrl);dt.fnUpdate(a,r,0),ianhd.app.showSuccess(),ianhd.app.clearViewModel()}else viewModel.message(e.Message)}),e.close()}}]})}),$(document).on("click",ianhd.app.selectors.deleteLinks,function(e){e.preventDefault();var t=$(this);BootstrapDialog.show({title:"Please Confirm",message:"Are you sure?",cssClass:"login-dialog",buttons:[{label:"Yes, delete",cssClass:"btn-primary",action:function(e){var n=t.closest("tr")[0],r=n.attributes["data-item-id"].value,a=dt.fnGetPosition(n);dt.fnDeleteRow(a),ianhd.app.showSuccess(),$.ajax({url:"links/"+r,type:"DELETE",success:function(){},error:function(){alert("Error :/")}}),e.close()}}]})}),ianhd.app.controls.shortenUrl().click(function(e){e.preventDefault();var t=ko.mapping.toJS(viewModel);$.trim(viewModel.path())?(t={destinationUrl:t.longUrl,path:t.path},$.post("links",t,function(e){if(e.WasSuccessful)viewModel.result(e.Item.ShortUrl),viewModel.items().length?viewModel.items.push(e.Item):ianhd.app.loadData(),ianhd.app.clearViewModel();else{if("UserAlreadyHasLink"===e.ResultEnum){var t="<a href='{0}' target='_blank' title='{0}'>link</a>".format(e.Item.DestinationUrl),n="<a href='#' class='overwrite' data-item-id='{0}'>Overwrite it</a>".format(e.Item.LinkId);e.Message=e.Message.replace("link",t).replace("Overwrite it",n)}viewModel.message(e.Message),viewModel.result("")}})):(t={longUrl:t.longUrl},$.ajax("https://www.googleapis.com/urlshortener/v1/url",{data:JSON.stringify(t),contentType:"application/json",type:"POST",success:function(e){viewModel.result(e.id),ianhd.app.clearViewModel()}}))})},showSuccess:function(){ianhd.app.controls.success().fadeIn(300).delay(2e3).fadeOut(500)},loadData:function(){viewModel.signedIn()&&$.get("links",function(e){viewModel.items(e),viewModel.loading(!1),viewModel.items().length&&(dt=$("#example").dataTable({aaSorting:[[2,"desc"]]}))})},removeHash:function(){history.pushState("",document.title,window.location.pathname+window.location.search)}},$(function(){ianhd.app.init()});