ianhd.registerNamespace("bookmarklet"),ianhd.bookmarklet={controls:{close:function(){return $(".closeWindow")},shortenUrl:function(){return $("button[type='submit']")},success:function(){return $(".alert-success.primary")},theRealCopy:function(){return $("#theRealCopy")}},selectors:{copyLinks:".copy",overwrite:".overwrite"},init:function(){ianhd.bookmarklet.initZeroClipboard(),ianhd.bookmarklet.bindControls(),ianhd.bookmarklet.removeHash(),ianhd.bookmarklet.listenForSignedIn()},initZeroClipboard:function(){ianhd.bookmarklet.controls.theRealCopy().zclip({path:"ZeroClipboard.swf",copy:function(){return viewModel.toCopy()},afterCopy:function(){var e=$(viewModel.copyTriggerSelector()),t=e.html();e.html("<span style='text-align: center; width: 46px; display:inline-block; color: green;'><i class='fa fa-check'></i></span>"),setTimeout(function(){e.html(t)},1500)}}),$(document).on("mouseover",ianhd.bookmarklet.selectors.copyLinks,function(e){e.stopPropagation();var t=$(this);t.addClass("hover"),viewModel.toCopy(viewModel.result()),viewModel.copyTriggerSelector(".copy"),$(".zclip").css("left",t.offset().left).css("top",t.offset().top)}),$(document).on("mouseover",".addBody",function(){$(this),$(".copy").removeClass("hover"),$(".zclip").css("left",-100).css("top",-100)})},bindControls:function(){ianhd.bookmarklet.controls.shortenUrl().click(function(e){e.preventDefault();var t=ko.mapping.toJS(viewModel);$.trim(viewModel.path())?(t={destinationUrl:t.longUrl,path:t.path},$.post("links",t,function(e){if(e.WasSuccessful)viewModel.result(e.Item.ShortUrl),ianhd.bookmarklet.clearViewModel();else{if("UserAlreadyHasLink"===e.ResultEnum){var t="<a href='{0}' target='_blank' title='{0}'>link</a>".format(e.Item.DestinationUrl),n="<a href='#' class='overwrite' data-item-id='{0}'>Overwrite it</a>".format(e.Item.LinkId);e.Message=e.Message.replace("link",t).replace("Overwrite it",n)}viewModel.error(e.Message),viewModel.success(""),viewModel.result("")}})):(t={longUrl:t.longUrl},$.ajax("https://www.googleapis.com/urlshortener/v1/url",{data:JSON.stringify(t),contentType:"application/json",type:"POST",success:function(e){viewModel.result(e.id),ianhd.bookmarklet.clearViewModel()}}))}),$(document).on("click",ianhd.bookmarklet.selectors.overwrite,function(e){e.preventDefault();var t=$(this);BootstrapDialog.show({title:"Please Confirm",message:"Are you sure?",cssClass:"login-dialog",buttons:[{label:"Yes, overwrite",cssClass:"btn-primary",action:function(e){var n=t.attr("data-item-id"),r={destinationUrl:viewModel.longUrl(),linkId:n};$.post("links/overwrite",r,function(e){e.WasSuccessful?(viewModel.result(e.Item.ShortUrl),ianhd.bookmarklet.showSuccess(),ianhd.bookmarklet.clearViewModel()):(viewModel.error(e.Message),viewModel.success(""))}),e.close()}}]})}),ianhd.bookmarklet.controls.close().click(function(e){e.preventDefault(),window.close()})},listenForSignedIn:function(){viewModel.signedIn()||setInterval(function(){viewModel.signedIn()||$.get("account/signed-in",function(e){e.signedIn&&(viewModel.signedIn(!0),viewModel.success("You've been signed in."))})},1e3)},clearViewModel:function(){viewModel.longUrl(""),viewModel.path(""),viewModel.error(""),viewModel.success("")},showSuccess:function(){ianhd.bookmarklet.controls.success().fadeIn(300).delay(2e3).fadeOut(500)},removeHash:function(){history.pushState("",document.title,window.location.pathname+window.location.search)}},$(function(){ianhd.bookmarklet.init()});